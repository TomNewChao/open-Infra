FROM openeuler/openeuler:22.03 as builder
RUN python3 -m ensurepip --default-pip && python3 -m pip install --upgrade pip
RUN pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
RUN pip config set global.trusted-host pypi.tuna.tsinghua.edu.cn
RUN pip config set global.timeout 120

RUN mkdir /opt/node
RUN mkdir -p /home/open-infra/web
WORKDIR /home/open-infra/web

RUN yum update -y && yum install wget -y
RUN cd /opt/node && wget https://npmmirror.com/mirrors/node/v16.16.0/node-v16.16.0-linux-x64.tar.xz && tar -xvf node-v16.16.0-linux-x64.tar.xz && mv node-v16.16.0-linux-x64 nodejs
RUN ln -s /opt/node/nodejs/bin/node /usr/local/bin/
RUN ln -s /opt/node/nodejs/bin/npm /usr/local/bin/
RUN npm config set registry http://registry.npm.taobao.org

COPY . /home/open-infra/web
RUN cd /home/open-infra/web && npm install
RUN cd /home/open-infra/web && npm run build



FROM openeuler/openeuler:22.03

# COPY ./deploy/test-login.html /usr/share/nginx/html/test-login.html

COPY --from=builder /home/open-infra/web/dist/ /usr/share/nginx/html/
RUN chmod -R 755 /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf


ENV RUN_USER nginx
ENV RUN_GROUP nginx
EXPOSE 8080
ENTRYPOINT ["nginx", "-g", "daemon off;"]

